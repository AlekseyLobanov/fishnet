#!/bin/sh

if [ -f Stockfish/src/stockfish ] && [ ! "$(git status --porcelain | grep 'M Stockfish')" ]; then
  echo "- Stockfish is up to date"
  exit 0;
fi

if [ -f /proc/cpuinfo ]; then
  ARCH=x86-64
  # detect if the CPU supports "modern" features
  if grep -q "^flags.*popcnt" /proc/cpuinfo ; then
    ARCH=x86-64-modern
  fi
else
  ARCH=x86-64-modern
fi

echo "- Detected architecture $ARCH"

echo "- Checking out latest Stockfish..."
git submodule update --init

cd Stockfish/src
echo "- Building and profiling Stockfish..."
echo "  This will take about 2 minutes, but is only needed once."
make profile-build ARCH=$ARCH > /dev/null
cd ../..
echo "- Done!"
